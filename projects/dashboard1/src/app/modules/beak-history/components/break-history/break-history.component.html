<div class="break-history-page">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-icon">
      <i class="fas fa-history"></i>
    </div>
    <h1 class="page-title">Lịch sử vỡ</h1>
  </div>

  <!-- Search and Filter Section -->
  <div class="filter-section">
    <div class="search-container">
      <input 
        type="text" 
        class="search-input" 
        placeholder="Tìm theo tên đồng hồ"
        [ngModel]="filter().searchTerm"
        (input)="onSearchTermChange($event)"
      >
      <i class="fas fa-search search-icon"></i>
    </div>
    
    <div class="filter-dropdown">
      <select 
        class="status-filter"
        [(ngModel)]="filter().statusFilter"
        (change)="onFilterChange()"
      >
        <option value="">Filter by Status</option>
        <option value="Normal">Normal</option>
        <option value="On fixing">On fixing</option>
        <option value="Anomaly detected">Anomaly detected</option>
      </select>
    </div>
    
    <button class="export-btn" (click)="exportData()">
      Xuất file dữ liệu
    </button>
  </div>

  <!-- Table Container with Professional Scroll -->
  <div class="table-container">
    <!-- Fixed Header -->
    <div class="table-header-fixed">
      <table class="break-history-table header-table">
        <thead>
          <tr>
            <th class="checkbox-column">
              <input 
                type="checkbox" 
                [checked]="selectAll()"
                (change)="onSelectAll()"
                class="table-checkbox"
              >
            </th>
            <th>Clock</th>
            <th>Address</th>
            <th>Status</th>
            <th>Date</th>
            <th>Detail</th>
          </tr>
        </thead>
      </table>
    </div>

    <!-- Scrollable Body -->
    <div class="table-body-scrollable">
      <table class="break-history-table body-table">
        <tbody>
          <ng-container *ngFor="let history of filteredHistories(); trackBy: trackByHistoryId">
            <!-- Main Row -->
            <tr 
              class="table-row"
              [class.selected]="history.selected"
              [class.expanded]="history.expanded"
            >
              <td class="checkbox-column">
                <input 
                  type="checkbox" 
                  [checked]="history.selected || false"
                  (change)="onItemSelect(history.id)"
                  class="table-checkbox"
                >
              </td>
              <td class="clock-column">{{ history.clock }}</td>
              <td class="address-column">{{ history.address }}</td>
              <td class="status-column">
                <span class="status-badge" [ngClass]="getStatusClass(history.status)">
                  {{ history.status }}
                </span>
              </td>
              <td class="date-column">{{ history.date }}</td>
              <td class="actions-column">
                <button 
                  class="action-btn detail-btn"
                  (click)="viewDetails(history.id)"
                  [class.rotated]="history.expanded"
                  title="Xem chi tiết"
                >
                  <i class="fas fa-chevron-down"></i>
                </button>
              </td>
            </tr>

            <!-- Detail Row -->
            <tr 
              class="detail-row"
              *ngIf="history.expanded"
              [@slideInOut]
            >
              <td colspan="6" class="detail-content">
                <div class="detail-container">
                  <div class="detail-header">
                    <h4 class="detail-title">Thông tin chi tiết lịch sử vỡ</h4>
                  </div>

                  <div class="detail-body">
                    <div class="detail-info-grid">
                      <div class="detail-item">
                        <span class="detail-label">Name:</span>
                        <span class="detail-value">{{ history.clock }}</span>
                      </div>

                      <div class="detail-item">
                        <span class="detail-label">Address:</span>
                        <span class="detail-value">{{ history.address }}</span>
                      </div>

                      <div class="detail-item">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">
                          <span class="status-badge" [ngClass]="getStatusClass(history.status)">
                            {{ history.status }}
                          </span>
                        </span>
                      </div>

                      <div class="detail-item">
                        <span class="detail-label">Break:</span>
                        <span class="detail-value break-count">{{ history.break }} (time)</span>
                      </div>

                      <div class="detail-item">
                        <span class="detail-label">Pipe material:</span>
                        <span class="detail-value">{{ history.pipeMaterial }}</span>
                      </div>

                      <div class="detail-item">
                        <span class="detail-label">Pipe length:</span>
                        <span class="detail-value">{{ history.pipeLength }} (m)</span>
                      </div>

                      <div class="detail-item">
                        <span class="detail-label">Latest repair:</span>
                        <span class="detail-value date-value">{{ history.latestRepair }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Export Popup -->
  <div class="popup-overlay" *ngIf="showExportPopup()" (click)="closeExportPopup()">
    <div class="popup-container" (click)="$event.stopPropagation()">
      <!-- No Selection Case -->
      <div *ngIf="!hasSelectedHistories()" class="popup-content">
        <div class="popup-icon warning">
          <i class="fas fa-exclamation"></i>
        </div>
        <h3 class="popup-title">Chưa chọn lịch sử nào</h3>
        <div class="popup-actions">
          <button class="popup-btn cancel" (click)="closeExportPopup()">
            Cancel
          </button>
        </div>
      </div>

      <!-- Confirmation Case -->
      <div *ngIf="hasSelectedHistories()" class="popup-content">
        <div class="popup-icon confirm">
          <i class="fas fa-file-export"></i>
        </div>
        <h3 class="popup-title">Xác nhận xuất file dữ liệu</h3>
        <p class="popup-message">Bạn có chắc chắn muốn xuất những file dữ liệu lịch sử này không?</p>
        <div class="popup-actions">
          <button class="popup-btn cancel" (click)="closeExportPopup()">
            Hủy
          </button>
          <button class="popup-btn confirm" (click)="confirmExport()">
            Xác nhận
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Notification -->
  <div class="notification-overlay" *ngIf="showSuccessNotification()" (click)="closeSuccessNotification()">
    <div class="notification-container" (click)="$event.stopPropagation()">
      <div class="notification-content">
        <div class="notification-icon success">
          <i class="fas fa-check"></i>
        </div>
        <h3 class="notification-title">Cập nhật thành công</h3>
        <div class="notification-actions">
          <button class="notification-btn ok" (click)="closeSuccessNotification()">
            OK
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
