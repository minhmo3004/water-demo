<div class="dashboard-container">
  <!-- Statistics Cards -->
  <div class="stats-row">
    <div class="stat-card anomaly-card">
      <div class="stat-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-title">Bất thường được phát hiện</div>
        <div class="stat-number">{{ totalAnomalies() }}</div>
        <div class="stat-label">bất thường</div>
      </div>
    </div>

    <div class="stat-card verified-card">
      <div class="stat-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-title">Bất thường được xác nhận</div>
        <div class="stat-number">{{ totalVerifiedAnomalies() }}</div>
        <div class="stat-label">xác nhận</div>
      </div>
    </div>
  </div>

  <!-- Main Content Section -->
  <div class="main-content-section">
    <!-- Data Table Section (40%) -->
    <div class="table-section">
      <div class="table-header">
        <div class="header-title-row">
          <h3 class="table-title">Dữ liệu đồng hồ trạm cấp nước</h3>
        </div>
        
        
        <div class="search-container">
            <div class="search-box">
              <i class="fas fa-search search-icon"></i>
              <input
                type="text"
                placeholder="Search"
                (input)="onSearchChange($event)"
                class="search-input"
              />
            </div>
        </div>
        
      </div>

      <div class="table-wrapper">
        <div class="table-header-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Tên trạm</th>
                <th>Địa chỉ</th>
                <th>Trạng thái</th>
              </tr>
            </thead>
          </table>
        </div>
        <div class="table-body-container">
          <table class="data-table">
            <tbody>
              <tr *ngFor="let item of filteredData(); trackBy: trackByFn">
                <td class="station-name" (click)="selectMeter(item)">
                  <span class="station-text" [class.active]="isMeterSelected(item)">
                    {{ item.meter_data.name }}
                  </span>
                </td>
                <td class="address">{{ item.meter_data.address }}</td>
                <td>
                  <span [class]="'status-badge ' + getStatusClass(item.meter_data.status)">
                    {{ getStatusText(item.meter_data.status) }}
                  </span>
                </td>
              </tr>
              <tr *ngIf="filteredData().length === 0">
                <td colspan="3" class="no-data">Không có dữ liệu</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Van Dau 8 Detail Section (60%) -->
    <div class="detail-section">
      <div class="detail-header">
        <!-- Title Row -->
        <div class="header-title-row">
          <h3 class="detail-title">{{ selectedMeterName() || 'Chọn trạm để xem chi tiết' }}</h3>
        </div>
        
        <!-- Tabs Row -->
        <div class="header-tabs-row">
          <div class="header-tabs">
            <button 
              class="header-tab-button" 
              [class.active]="isActiveTab('general')"
              (click)="switchChartTab('general')">
              Tổng quát
            </button>
            <button 
              class="header-tab-button" 
              [class.active]="isActiveTab('anomaly')"
              (click)="switchChartTab('anomaly')">
              Hiển thị bất thường
            </button>
            <button 
              class="header-tab-button" 
              [class.active]="isActiveTab('anomaly-ai')"
              (click)="switchChartTab('anomaly-ai')">
              Hiển thị bất thường - AI
            </button>
          </div>
        </div>
      </div>

      <div class="detail-content">
        <!-- Chart Section -->
        <div class="chart-section">
          
          <!-- Chart Content -->
          <div class="chart-content">
            <!-- Chart Header Info -->
            <div class="chart-header-info">
              <ng-container *ngIf="chartState().chartData as cd; else noData">
                <h4 class="chart-main-title">{{ cd.config.title }}</h4>
                <p class="chart-subtitle">{{ cd.config.subtitle }}</p>
              </ng-container>
              <ng-template #noData>
                <h4 class="chart-main-title">Chưa có dữ liệu</h4>
                <p class="chart-subtitle"></p>
              </ng-template>
            </div>
            
            <!-- Professional Chart -->
            <div class="chart-wrapper">
              <div class="chart-container-with-grid">
                <svg viewBox="0 0 900 350" class="flow-chart" preserveAspectRatio="xMidYMid meet">
                  <!-- Background -->
                  <rect width="100%" height="100%" fill="white"/>
                  
                  <!-- Chart border -->
                  <rect x="70" y="30" width="800" height="280" fill="none" stroke="#e0e0e0" stroke-width="1"/>
                  
                  <!-- Horizontal grid lines -->
                  <g stroke="#f0f0f0" stroke-width="1">
                    <line x1="70" y1="310" x2="870" y2="310"/>
                    <line x1="70" y1="240" x2="870" y2="240"/>
                    <line x1="70" y1="170" x2="870" y2="170"/>
                    <line x1="70" y1="100" x2="870" y2="100"/>
                    <line x1="70" y1="30" x2="870" y2="30"/>
                  </g>
                  
                  <!-- Vertical grid lines -->
                  <g stroke="#f0f0f0" stroke-width="1">
                    <line x1="70" y1="30" x2="70" y2="310"/>
                    <line x1="185" y1="30" x2="185" y2="310"/>
                    <line x1="300" y1="30" x2="300" y2="310"/>
                    <line x1="415" y1="30" x2="415" y2="310"/>
                    <line x1="530" y1="30" x2="530" y2="310"/>
                    <line x1="645" y1="30" x2="645" y2="310"/>
                    <line x1="760" y1="30" x2="760" y2="310"/>
                    <line x1="870" y1="30" x2="870" y2="310"/>
                  </g>
                  
                  <!-- Y-axis labels inside SVG -->
                  <g fill="#666" font-size="11" font-family="Arial, sans-serif">
                    <text x="60" y="315" text-anchor="end">0</text>
                    <text x="60" y="245" text-anchor="end">10</text>
                    <text x="60" y="175" text-anchor="end">20</text>
                    <text x="60" y="105" text-anchor="end">30</text>
                    <text x="60" y="35" text-anchor="end">40</text>
                  </g>

                  <!-- Legend inside chart -->
                  <g class="chart-legend-group" *ngIf="chartState().chartData as cd">
                    <!-- Legend background -->
                    <rect x="90" y="45" [attr.width]="200" height="50" fill="white" stroke="#e0e0e0" stroke-width="1" rx="4"/>
                    <ng-container *ngFor="let item of cd.config.legend; let i = index">
                      <line [attr.x1]="100" [attr.y1]="60 + i * 20" [attr.x2]="120" [attr.y2]="60 + i * 20" [attr.stroke]="item.color" stroke-width="3"/>
                      <text [attr.x]="125" [attr.y]="64 + i * 20" fill="#333" font-size="12" font-family="Arial, sans-serif">{{ item.label }}</text>
                    </ng-container>
                  </g>
                  
                  <ng-container *ngIf="chartState().chartData as cd">
                    <polyline fill="none" [attr.stroke]="cd.config.legend[0].color" stroke-width="2.5" [attr.points]="getPolylinePoints(cd.data, 'value')"/>
                    <polyline fill="none" [attr.stroke]="cd.config.legend[1].color" stroke-width="2.5" [attr.points]="getPolylinePoints(cd.data, 'predictedValue')"/>
                  </ng-container>
                </svg>
              </div>
              
              <!-- X-axis labels -->
              <div class="chart-x-axis" *ngIf="chartState().chartData as cd">
                <span class="x-axis-label" *ngFor="let t of getXAxisLabels(cd.data)">{{ t }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
